name: CI

on:
  push:
  pull_request:

permissions:
  contents: read
  issues: write

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Check (app)
        run: cargo check --features app

      - name: Check (no default features)
        run: cargo check --no-default-features

      - name: Test (library)
        run: cargo test --lib -- --skip regression_large_position_upload_no_overrun

  scientific-pr-cpu-docs:
    runs-on: ubuntu-latest
    needs: checks
    env:
      TRIPPY_BALL_SCI_SAMPLE_LEVEL: pr
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run scientific CPU/docs checks
        id: run_scientific_cpu_docs
        run: |
          set +e
          set -o pipefail
          cargo test --test scientific_cpu_invariants --no-default-features 2>&1 | tee scientific_cpu_invariants.log
          cpu_status=${PIPESTATUS[0]}
          cargo test --test scientific_docs_consistency --no-default-features 2>&1 | tee scientific_docs_consistency.log
          docs_status=${PIPESTATUS[0]}
          cat scientific_cpu_invariants.log scientific_docs_consistency.log > scientific_pr_cpu_docs.log
          combined=0
          if [ "$cpu_status" -ne 0 ] || [ "$docs_status" -ne 0 ]; then
            combined=1
          fi
          echo "exit_code=${combined}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build scientific report (CPU/docs)
        run: |
          ./scripts/scientific/report.sh \
            "scientific-pr-cpu-docs" \
            "$([[ '${{ steps.run_scientific_cpu_docs.outputs.exit_code }}' == '0' ]] && echo passed || echo failed)" \
            "scientific_pr_cpu_docs.log" \
            "artifacts/scientific-pr-cpu-docs" \
            "TRIPPY_BALL_SCI_SAMPLE_LEVEL=pr cargo test --test scientific_cpu_invariants --no-default-features && TRIPPY_BALL_SCI_SAMPLE_LEVEL=pr cargo test --test scientific_docs_consistency --no-default-features"

      - name: Upload scientific CPU/docs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scientific-pr-cpu-docs
          path: artifacts/scientific-pr-cpu-docs

      - name: Open/update scientific remediation issue (CPU/docs)
        if: ${{ steps.run_scientific_cpu_docs.outputs.exit_code != '0' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIPPY_BALL_SCI_OWNER: ${{ vars.TRIPPY_BALL_SCI_OWNER }}
        run: |
          ./scripts/scientific/open_or_update_issue.sh \
            "scientific-pr-cpu-docs" \
            "artifacts/scientific-pr-cpu-docs/scientific_report.md"

      - name: Fail job if scientific CPU/docs checks failed
        if: ${{ steps.run_scientific_cpu_docs.outputs.exit_code != '0' }}
        run: exit 1

  scientific-pr-gpu:
    runs-on: macos-latest
    needs: checks
    env:
      TRIPPY_BALL_SCI_SAMPLE_LEVEL: pr
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run scientific GPU PR parity checks
        id: run_scientific_gpu
        run: |
          set +e
          set -o pipefail
          cargo test --test scientific_gpu_parity_pr 2>&1 | tee scientific_gpu_parity_pr.log
          test_status=${PIPESTATUS[0]}
          echo "exit_code=${test_status}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build scientific report (GPU PR)
        run: |
          ./scripts/scientific/report.sh \
            "scientific-pr-gpu" \
            "$([[ '${{ steps.run_scientific_gpu.outputs.exit_code }}' == '0' ]] && echo passed || echo failed)" \
            "scientific_gpu_parity_pr.log" \
            "artifacts/scientific-pr-gpu" \
            "TRIPPY_BALL_SCI_SAMPLE_LEVEL=pr cargo test --test scientific_gpu_parity_pr"

      - name: Upload scientific GPU artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scientific-pr-gpu
          path: artifacts/scientific-pr-gpu

      - name: Open/update scientific remediation issue (GPU PR)
        if: ${{ steps.run_scientific_gpu.outputs.exit_code != '0' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIPPY_BALL_SCI_OWNER: ${{ vars.TRIPPY_BALL_SCI_OWNER }}
        run: |
          ./scripts/scientific/open_or_update_issue.sh \
            "scientific-pr-gpu" \
            "artifacts/scientific-pr-gpu/scientific_report.md"

      - name: Fail job if scientific GPU checks failed
        if: ${{ steps.run_scientific_gpu.outputs.exit_code != '0' }}
        run: exit 1

  benchmark-smoke:
    runs-on: macos-latest
    needs:
      - checks
      - scientific-pr-cpu-docs
      - scientific-pr-gpu
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Benchmark smoke
        run: cargo run --release -- --benchmark
