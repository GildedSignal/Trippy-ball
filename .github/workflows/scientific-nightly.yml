name: Scientific Nightly

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  scientific-nightly-cpu-docs:
    runs-on: ubuntu-latest
    env:
      TRIPPY_BALL_SCI_SAMPLE_LEVEL: nightly
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run nightly scientific CPU/docs checks
        id: run_nightly_cpu_docs
        run: |
          set +e
          set -o pipefail
          cargo test --test scientific_cpu_invariants --no-default-features 2>&1 | tee scientific_cpu_invariants.log
          cpu_status=${PIPESTATUS[0]}
          cargo test --test scientific_docs_consistency --no-default-features 2>&1 | tee scientific_docs_consistency.log
          docs_status=${PIPESTATUS[0]}
          cat scientific_cpu_invariants.log scientific_docs_consistency.log > scientific_nightly_cpu_docs.log
          combined=0
          if [ "$cpu_status" -ne 0 ] || [ "$docs_status" -ne 0 ]; then
            combined=1
          fi
          echo "exit_code=${combined}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build nightly scientific report (CPU/docs)
        run: |
          ./scripts/scientific/report.sh \
            "scientific-nightly-cpu-docs" \
            "$([[ '${{ steps.run_nightly_cpu_docs.outputs.exit_code }}' == '0' ]] && echo passed || echo failed)" \
            "scientific_nightly_cpu_docs.log" \
            "artifacts/scientific-nightly-cpu-docs" \
            "TRIPPY_BALL_SCI_SAMPLE_LEVEL=nightly cargo test --test scientific_cpu_invariants --no-default-features && TRIPPY_BALL_SCI_SAMPLE_LEVEL=nightly cargo test --test scientific_docs_consistency --no-default-features"

      - name: Upload nightly CPU/docs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scientific-nightly-cpu-docs
          path: artifacts/scientific-nightly-cpu-docs

      - name: Open/update scientific remediation issue (nightly CPU/docs)
        if: ${{ steps.run_nightly_cpu_docs.outputs.exit_code != '0' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIPPY_BALL_SCI_OWNER: ${{ vars.TRIPPY_BALL_SCI_OWNER }}
        run: |
          ./scripts/scientific/open_or_update_issue.sh \
            "scientific-nightly-cpu-docs" \
            "artifacts/scientific-nightly-cpu-docs/scientific_report.md"

      - name: Fail job if nightly scientific CPU/docs checks failed
        if: ${{ steps.run_nightly_cpu_docs.outputs.exit_code != '0' }}
        run: exit 1

  scientific-nightly-gpu:
    runs-on: macos-latest
    needs: scientific-nightly-cpu-docs
    env:
      TRIPPY_BALL_SCI_SAMPLE_LEVEL: nightly
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run nightly scientific GPU parity sweep
        id: run_nightly_gpu
        run: |
          set +e
          set -o pipefail
          cargo test --test scientific_gpu_parity_nightly 2>&1 | tee scientific_gpu_parity_nightly.log
          test_status=${PIPESTATUS[0]}
          echo "exit_code=${test_status}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build nightly scientific report (GPU)
        run: |
          ./scripts/scientific/report.sh \
            "scientific-nightly-gpu" \
            "$([[ '${{ steps.run_nightly_gpu.outputs.exit_code }}' == '0' ]] && echo passed || echo failed)" \
            "scientific_gpu_parity_nightly.log" \
            "artifacts/scientific-nightly-gpu" \
            "TRIPPY_BALL_SCI_SAMPLE_LEVEL=nightly cargo test --test scientific_gpu_parity_nightly"

      - name: Upload nightly GPU artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scientific-nightly-gpu
          path: artifacts/scientific-nightly-gpu

      - name: Open/update scientific remediation issue (nightly GPU)
        if: ${{ steps.run_nightly_gpu.outputs.exit_code != '0' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIPPY_BALL_SCI_OWNER: ${{ vars.TRIPPY_BALL_SCI_OWNER }}
        run: |
          ./scripts/scientific/open_or_update_issue.sh \
            "scientific-nightly-gpu" \
            "artifacts/scientific-nightly-gpu/scientific_report.md"

      - name: Fail job if nightly scientific GPU checks failed
        if: ${{ steps.run_nightly_gpu.outputs.exit_code != '0' }}
        run: exit 1
